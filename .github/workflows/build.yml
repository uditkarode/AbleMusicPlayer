name: Build Release APK

on:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASS: ${{ secrets.KEY_PASS }}
      STORE_PASS: ${{ secrets.STORE_PASS }}

    steps:
      # ---------- Setup ----------

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: gradle

      # ---------- Notify build started ----------

      - name: Telegram â€” build started
        env:
          TG_BOT_KEY: ${{ secrets.TG_BOT_KEY }}
        run: |
          SHORT_SHA="${GITHUB_SHA::8}"
          curl -sf -X POST "https://api.telegram.org/bot${TG_BOT_KEY}/sendMessage" \
            -d chat_id="-1001415196670" \
            -d disable_web_page_preview=true \
            -d parse_mode=markdown \
            -d text="ðŸ¤– \`building with HEAD as\` [${SHORT_SHA}](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA}) ðŸ¤–"

      # ---------- Prepare build ----------

      # Inject API keys into source (replaced at compile time)
      - name: Inject API keys
        env:
          RAPID_KEY: ${{ secrets.RAPID_KEY }}
        run: |
          CONSTANTS="app/src/main/kotlin/io/github/uditkarode/able/utils/Constants.kt"
          sed -i "s/INSERT_RAPID_KEY/${RAPID_KEY}/" "$CONSTANTS"

      # Clone the release keystore from a private repo (read-only PAT)
      - name: Fetch signing keystore
        env:
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          git clone --depth 1 \
            "https://x-access-token:${TOKEN}@github.com/uditkarode/AbleMusicKeystore.git" \
            _keystore
          mv _keystore/release.keystore app/
          rm -rf _keystore

      # ---------- Build ----------

      - name: Build release APK
        run: ./gradlew :app:assembleRelease --configuration-cache --parallel

      # ---------- Upload artifacts ----------

      # Rename and upload each per-ABI APK to Telegram channel
      - name: Telegram â€” upload APKs
        env:
          TG_BOT_KEY: ${{ secrets.TG_BOT_KEY }}
        run: |
          SHORT_SHA="${GITHUB_SHA::8}"
          for APK in app/build/outputs/apk/release/*.apk; do
            ABI=$(basename "$APK" .apk | sed 's/app-//' | sed 's/-release//' | sed 's/-unsigned//')
            RENAMED="app/build/outputs/apk/release/AbleMusic-${ABI}-${SHORT_SHA}.apk"
            mv "$APK" "$RENAMED"
            curl -sf -F document=@"${RENAMED}" \
              "https://api.telegram.org/bot${TG_BOT_KEY}/sendDocument" \
              -F chat_id="-1001415196670" \
              -F parse_mode=Markdown \
              -F caption="\`${SHORT_SHA} â€” ${ABI}\`"
          done

      # Also save APKs as GitHub Actions artifacts for easy download
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AbleMusic-${{ github.sha }}
          path: app/build/outputs/apk/release/*.apk

      # Create a GitHub Release with the APKs
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHORT_SHA="${GITHUB_SHA::8}"
          TAG="build-${SHORT_SHA}"
          COMMIT_MSG=$(git log -1 --pretty=%s)
          NOTES=$(printf 'Automated release from commit [`%s`](https://github.com/${{ github.repository }}/commit/%s)\n\n**%s**' \
            "$SHORT_SHA" "$GITHUB_SHA" "$COMMIT_MSG")
          gh release create "$TAG" \
            --title "Build ${SHORT_SHA}" \
            --notes "$NOTES" \
            --latest \
            app/build/outputs/apk/release/*.apk

      # ---------- Notify build finished ----------

      - name: Telegram â€” build finished
        env:
          TG_BOT_KEY: ${{ secrets.TG_BOT_KEY }}
        run: |
          SHORT_SHA="${GITHUB_SHA::8}"
          curl -sf -X POST "https://api.telegram.org/bot${TG_BOT_KEY}/sendMessage" \
            -d chat_id="-1001415196670" \
            -d disable_web_page_preview=true \
            -d parse_mode=markdown \
            -d text="ðŸ¤– \`workflow for\` [${SHORT_SHA}](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA}) \`finished\` ðŸ¤–"
          curl -sf -X POST "https://api.telegram.org/bot${TG_BOT_KEY}/sendSticker" \
            -d chat_id="-1001415196670" \
            -d sticker="CAACAgUAAxkBAAJc416cRVy18acXP6HgtZSnxuuoJi01AAK9AAMtO2YjehthhceJ__sYBA"
